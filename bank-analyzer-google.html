<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analizzatore Movimenti Bancari</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>
    <style>
* { margin: 0; padding: 0; box-sizing: border-box; }
:root {
    --primary: #2563eb; --primary-dark: #1d4ed8; --success: #10b981;
    --danger: #ef4444; --warning: #f59e0b; --gray-50: #f9fafb;
    --gray-100: #f3f4f6; --gray-200: #e5e7eb; --gray-300: #d1d5db;
    --gray-500: #6b7280; --gray-700: #374151; --gray-900: #111827;
    --shadow: 0 1px 3px rgba(0,0,0,0.1); --shadow-lg: 0 10px 25px rgba(0,0,0,0.1);
}
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--gray-100); color: var(--gray-900); line-height: 1.5; }
.container { max-width: 1600px; margin: 0 auto; padding: 1rem; }
button { cursor: pointer; border: none; padding: 0.5rem 1rem; border-radius: 0.375rem; font-size: 0.875rem; font-weight: 500; transition: all 0.2s; }
.btn-primary { background: var(--primary); color: white; }
.btn-primary:hover { background: var(--primary-dark); }
.btn-secondary { background: var(--gray-200); color: var(--gray-700); }
.btn-secondary:hover { background: var(--gray-300); }
.btn-danger { background: var(--danger); color: white; }
.btn-success { background: var(--success); color: white; }
.btn-google { background: #4285f4; color: white; display: flex; align-items: center; gap: 0.5rem; }
.btn-google:hover { background: #3367d6; }
.btn-google.connected { background: var(--success); }
input, select { padding: 0.5rem 0.75rem; border: 1px solid var(--gray-300); border-radius: 0.375rem; font-size: 0.875rem; }
input:focus, select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }
.card { background: white; border-radius: 0.5rem; box-shadow: var(--shadow); padding: 1rem; margin-bottom: 1rem; }

/* HEADER */
.header { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; padding: 1.5rem; margin-bottom: 1rem; border-radius: 0.5rem; }
.header h1 { font-size: 1.5rem; margin-bottom: 1rem; }
.header-actions { display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: center; }
.header-actions button { background: rgba(255,255,255,0.2); color: white; }
.header-actions button:hover { background: rgba(255,255,255,0.3); }
.file-input-wrapper { position: relative; display: inline-block; }
.file-input-wrapper input[type="file"] { position: absolute; top: 0; left: 0; opacity: 0; width: 100%; height: 100%; cursor: pointer; z-index: 10; }

/* GOOGLE DRIVE STATUS */
.gdrive-status { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: rgba(255,255,255,0.1); border-radius: 0.375rem; font-size: 0.875rem; }
.gdrive-status .dot { width: 8px; height: 8px; border-radius: 50%; background: var(--danger); }
.gdrive-status.connected .dot { background: var(--success); }
.gdrive-status .sync-icon { animation: spin 1s linear infinite; }
@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

/* YEAR SELECTOR */
.year-selector { display: flex; align-items: center; gap: 0.5rem; margin-left: auto; }
.year-selector label { font-weight: 500; }
.year-selector select { background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 0.5rem 1rem; font-size: 1rem; font-weight: 600; }
.year-selector select option { color: var(--gray-900); }

/* LOADED MONTHS */
.loaded-months { margin-bottom: 1rem; }
.loaded-months h3 { font-size: 0.875rem; color: var(--gray-500); margin-bottom: 0.5rem; text-transform: uppercase; }
.months-tags { display: flex; flex-wrap: wrap; gap: 0.5rem; }
.month-tag { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.75rem; background: var(--primary); color: white; border-radius: 9999px; font-size: 0.875rem; font-weight: 500; }
.month-tag .count { background: rgba(255,255,255,0.3); padding: 0.125rem 0.5rem; border-radius: 9999px; font-size: 0.75rem; }
.month-tag .delete { background: none; border: none; color: white; cursor: pointer; padding: 0; margin-left: 0.25rem; opacity: 0.7; font-size: 1.1rem; line-height: 1; }
.month-tag .delete:hover { opacity: 1; }
.no-data-msg { color: var(--gray-500); font-style: italic; }

/* FILTERS */
.filters { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 0.75rem; align-items: end; }
.filter-group { display: flex; flex-direction: column; gap: 0.25rem; }
.filter-group label { font-size: 0.75rem; font-weight: 500; color: var(--gray-500); text-transform: uppercase; }
.checkbox-group { display: flex; align-items: center; gap: 0.5rem; padding-top: 1.5rem; }
.checkbox-group input { width: 1rem; height: 1rem; }

/* KPI GRID */
.kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1rem; }
.kpi-card { background: white; padding: 1rem; border-radius: 0.5rem; box-shadow: var(--shadow); text-align: center; }
.kpi-card .value { font-size: 1.5rem; font-weight: 700; }
.kpi-card .label { font-size: 0.75rem; color: var(--gray-500); text-transform: uppercase; }
.kpi-card.income .value { color: var(--success); }
.kpi-card.expense .value { color: var(--danger); }
.kpi-card.balance .value { color: var(--primary); }

/* TABLE */
.table-container { overflow-x: auto; max-height: 500px; overflow-y: auto; }
table { width: 100%; border-collapse: collapse; font-size: 0.875rem; }
thead { position: sticky; top: 0; background: var(--gray-100); z-index: 10; }
th, td { padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--gray-200); }
th { font-weight: 600; color: var(--gray-700); cursor: pointer; user-select: none; white-space: nowrap; }
th:hover { background: var(--gray-200); }
th.sorted-asc::after { content: ' ‚ñ≤'; }
th.sorted-desc::after { content: ' ‚ñº'; }
tr:hover { background: var(--gray-50); }
.amount-positive { color: var(--success); font-weight: 600; }
.amount-negative { color: var(--danger); font-weight: 600; }
.type-badge { padding: 0.25rem 0.5rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 500; }
.type-entrata { background: #d1fae5; color: #065f46; }
.type-uscita { background: #fee2e2; color: #991b1b; }
.category-select { padding: 0.25rem; font-size: 0.75rem; min-width: 120px; }
.table-footer { display: flex; justify-content: space-between; padding: 1rem; background: var(--gray-100); font-weight: 600; border-radius: 0 0 0.5rem 0.5rem; flex-wrap: wrap; gap: 0.5rem; }
tr.clickable { cursor: pointer; }

/* CHARTS */
.charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 1rem; margin-bottom: 1rem; }
.chart-card { background: white; padding: 1rem; border-radius: 0.5rem; box-shadow: var(--shadow); }
.chart-card h3 { margin-bottom: 1rem; font-size: 1rem; }
.chart-container { position: relative; height: 300px; }

/* TOP LISTS */
.top-lists { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; }
.top-list { background: white; padding: 1rem; border-radius: 0.5rem; box-shadow: var(--shadow); }
.top-list h3 { margin-bottom: 0.75rem; font-size: 1rem; }
.top-item { display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid var(--gray-100); font-size: 0.875rem; }
.top-item:last-child { border-bottom: none; }
.top-item .name { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; margin-right: 1rem; }
.top-item .value { font-weight: 600; white-space: nowrap; }

/* MODAL */
.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s; }
.modal-overlay.active { opacity: 1; visibility: visible; }
.modal { background: white; border-radius: 0.5rem; box-shadow: var(--shadow-lg); max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; transform: scale(0.9); transition: transform 0.3s; }
.modal-overlay.active .modal { transform: scale(1); }
.modal-header { display: flex; justify-content: space-between; align-items: center; padding: 1rem; border-bottom: 1px solid var(--gray-200); }
.modal-header h2 { font-size: 1.125rem; }
.modal-close { background: none; padding: 0.5rem; font-size: 1.5rem; color: var(--gray-500); }
.modal-body { padding: 1rem; }
.detail-row { display: flex; padding: 0.75rem 0; border-bottom: 1px solid var(--gray-100); }
.detail-row:last-child { border-bottom: none; }
.detail-label { width: 140px; font-weight: 500; color: var(--gray-500); }
.detail-value { flex: 1; }

/* RULES */
.rule-item { display: flex; gap: 0.5rem; align-items: center; padding: 0.5rem; background: var(--gray-50); border-radius: 0.375rem; margin-bottom: 0.5rem; }
.rule-item input { flex: 1; }
.add-rule-form { display: flex; gap: 0.5rem; margin-top: 0.5rem; flex-wrap: wrap; }
.add-rule-form input { flex: 1; min-width: 150px; }

/* TABS */
.tabs { display: flex; gap: 0.25rem; margin-bottom: 1rem; border-bottom: 2px solid var(--gray-200); }
.tab { padding: 0.75rem 1rem; background: none; color: var(--gray-500); border-bottom: 2px solid transparent; margin-bottom: -2px; }
.tab.active { color: var(--primary); border-bottom-color: var(--primary); }
.tab-content { display: none; }
.tab-content.active { display: block; }

/* TOAST */
.toast { position: fixed; bottom: 1rem; right: 1rem; padding: 1rem 1.5rem; background: var(--gray-900); color: white; border-radius: 0.5rem; box-shadow: var(--shadow-lg); transform: translateY(100px); opacity: 0; transition: all 0.3s; z-index: 2000; }
.toast.show { transform: translateY(0); opacity: 1; }
.toast.success { background: var(--success); }
.toast.error { background: var(--danger); }

/* SETUP INFO */
.setup-info { background: #fef3c7; border: 1px solid #f59e0b; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem; }
.setup-info h3 { color: #92400e; margin-bottom: 0.5rem; }
.setup-info p, .setup-info li { color: #78350f; font-size: 0.875rem; }
.setup-info code { background: rgba(0,0,0,0.1); padding: 0.125rem 0.25rem; border-radius: 0.25rem; font-size: 0.8rem; }

@media (max-width: 768px) {
    .filters { grid-template-columns: 1fr 1fr; }
    .charts-grid { grid-template-columns: 1fr; }
    .kpi-grid { grid-template-columns: repeat(2, 1fr); }
    .header-actions { flex-direction: column; align-items: stretch; }
    .year-selector { margin-left: 0; margin-top: 1rem; justify-content: center; }
}
    </style>
</head>
<body>
    <div class="container">
        <!-- SETUP INFO (mostrato solo se non configurato) -->
        <div class="setup-info" id="setupInfo" style="display:none;">
            <h3>‚öôÔ∏è Configurazione Google Drive</h3>
            <p>Per abilitare il salvataggio su Google Drive, inserisci il tuo Client ID nella variabile <code>GOOGLE_CLIENT_ID</code> nel codice.</p>
            <p style="margin-top:0.5rem;">Nel frattempo, i dati vengono salvati localmente nel browser.</p>
        </div>

        <!-- HEADER -->
        <div class="header">
            <h1>üìä Analizzatore Movimenti Bancari</h1>
            <div class="header-actions">
                <div class="file-input-wrapper">
                    <button>üìÅ Carica XLSX</button>
                    <input type="file" id="fileInput" accept=".xlsx,.xls">
                </div>
                <button onclick="exportBackup()">üíæ Esporta Backup</button>
                <div class="file-input-wrapper">
                    <button>üì• Importa Backup</button>
                    <input type="file" id="backupInput" accept=".json">
                </div>
                <button onclick="openRulesModal()">‚öôÔ∏è Regole Auto</button>
                
                <!-- Google Drive -->
                <div class="gdrive-status" id="gdriveStatus">
                    <span class="dot"></span>
                    <span id="gdriveStatusText">Drive: non connesso</span>
                </div>
                <button class="btn-google" id="gdriveBtn" onclick="handleGoogleAuth()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M12.545,10.239v3.821h5.445c-0.712,2.315-2.647,3.972-5.445,3.972c-3.332,0-6.033-2.701-6.033-6.032s2.701-6.032,6.033-6.032c1.498,0,2.866,0.549,3.921,1.453l2.814-2.814C17.503,2.988,15.139,2,12.545,2C7.021,2,2.543,6.477,2.543,12s4.478,10,10.002,10c8.396,0,10.249-7.85,9.426-11.748L12.545,10.239z"/></svg>
                    <span id="gdriveBtnText">Connetti Drive</span>
                </button>
                
                <div class="year-selector">
                    <label>üìÖ Anno:</label>
                    <select id="yearSelector">
                        <option value="">Tutti gli anni</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- LOADED MONTHS -->
        <div class="card loaded-months">
            <h3>üìÜ Mesi Caricati</h3>
            <div class="months-tags" id="monthsTags">
                <span class="no-data-msg">Nessun dato caricato. Importa un file XLSX per iniziare.</span>
            </div>
        </div>

        <!-- FILTERS -->
        <div class="card">
            <div class="filters">
                <div class="filter-group">
                    <label>Mese</label>
                    <select id="filterMonth"><option value="">Tutti</option></select>
                </div>
                <div class="filter-group">
                    <label>Tipo</label>
                    <select id="filterType">
                        <option value="">Tutti</option>
                        <option value="entrata">Entrate</option>
                        <option value="uscita">Uscite</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Categoria</label>
                    <select id="filterCategory"><option value="">Tutte</option></select>
                </div>
                <div class="filter-group">
                    <label>Cerca</label>
                    <input type="text" id="filterSearch" placeholder="Descrizione o dettaglio...">
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="filterNoCategory">
                    <label for="filterNoCategory">Solo senza categoria</label>
                </div>
            </div>
        </div>

        <!-- KPI -->
        <div class="kpi-grid" id="kpiGrid"></div>

        <!-- TABS -->
        <div class="tabs">
            <button class="tab active" data-tab="table">üìã Movimenti</button>
            <button class="tab" data-tab="charts">üìà Grafici</button>
            <button class="tab" data-tab="stats">üìä Statistiche</button>
        </div>

        <!-- TAB: TABLE -->
        <div class="tab-content active" id="tab-table">
            <div class="card">
                <div class="table-container">
                    <table id="transactionsTable">
                        <thead>
                            <tr>
                                <th data-sort="data_valuta">Data Valuta</th>
                                <th data-sort="data_contabile">Data Contabile</th>
                                <th data-sort="descrizione">Descrizione</th>
                                <th>Dettaglio</th>
                                <th>Categoria</th>
                                <th data-sort="importo">Importo</th>
                                <th>Tipo</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
                <div class="table-footer" id="tableFooter"></div>
            </div>
        </div>

        <!-- TAB: CHARTS -->
        <div class="tab-content" id="tab-charts">
            <div class="charts-grid">
                <div class="chart-card">
                    <h3>Spese per Categoria</h3>
                    <div class="chart-container"><canvas id="pieChart"></canvas></div>
                </div>
                <div class="chart-card">
                    <h3>Top Categorie per Spesa</h3>
                    <div class="chart-container"><canvas id="barChart"></canvas></div>
                </div>
                <div class="chart-card" style="grid-column: 1 / -1;">
                    <h3>Andamento Saldo Cumulativo</h3>
                    <div class="chart-container"><canvas id="lineChart"></canvas></div>
                </div>
            </div>
        </div>

        <!-- TAB: STATS -->
        <div class="tab-content" id="tab-stats">
            <div class="top-lists" id="topLists"></div>
        </div>
    </div>

    <!-- MODALS -->
    <div class="modal-overlay" id="detailModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Dettaglio Transazione</h2>
                <button class="modal-close" onclick="closeModal('detailModal')">&times;</button>
            </div>
            <div class="modal-body" id="detailBody"></div>
        </div>
    </div>

    <div class="modal-overlay" id="rulesModal">
        <div class="modal">
            <div class="modal-header">
                <h2>‚öôÔ∏è Regole Automatiche Categorie</h2>
                <button class="modal-close" onclick="closeModal('rulesModal')">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom:1rem;color:var(--gray-500);font-size:0.875rem;">
                    Se la descrizione contiene il testo specificato, verr√† assegnata automaticamente la categoria.
                </p>
                <div id="rulesList"></div>
                <div class="add-rule-form">
                    <input type="text" id="newRuleText" placeholder="Testo da cercare (es. AMAZON)">
                    <input type="text" id="newRuleCategory" placeholder="Categoria da assegnare">
                    <button class="btn-primary" onclick="addRule()">+ Aggiungi</button>
                </div>
                <div style="margin-top:1rem;display:flex;gap:0.5rem;">
                    <button class="btn-success" onclick="applyRulesToAll()">‚úì Applica a tutti</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="confirmModal">
        <div class="modal" style="max-width:400px;">
            <div class="modal-header">
                <h2>‚ö†Ô∏è Conferma</h2>
                <button class="modal-close" onclick="closeModal('confirmModal')">&times;</button>
            </div>
            <div class="modal-body" style="text-align:center;">
                <p id="confirmMessage" style="margin-bottom:1.5rem;"></p>
                <div style="display:flex;gap:1rem;justify-content:center;">
                    <button class="btn-secondary" onclick="closeModal('confirmModal')">Annulla</button>
                    <button class="btn-danger" id="confirmBtn">Elimina</button>
                </div>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

<script>
// ============================================
// CONFIGURAZIONE GOOGLE DRIVE
// ============================================
// ISTRUZIONI:
// 1. Vai su https://console.cloud.google.com/
// 2. Crea un nuovo progetto
// 3. Abilita "Google Drive API"
// 4. Vai su "Credenziali" > "Crea credenziali" > "ID client OAuth"
// 5. Tipo: "Applicazione web"
// 6. Aggiungi le origini JavaScript autorizzate (es: http://localhost, file://, o il tuo dominio)
// 7. Copia il Client ID qui sotto

const GOOGLE_CLIENT_ID = '233164614160-5u6eaqv9tlp1l2qh2iih5apv95flkift.apps.googleusercontent.com'; // <-- INSERISCI QUI IL TUO CLIENT ID
const GOOGLE_API_KEY = ''; // Opzionale, per alcune funzionalit√†
const DRIVE_FILE_NAME = 'bank_analyzer_data.json';
const SCOPES = 'https://www.googleapis.com/auth/drive.file';

// ============================================
// APP STATE
// ============================================
let transactions = [];
let categories = ['Alimentari', 'Trasporti', 'Utenze', 'Shopping', 'Stipendio', 'Salute', 'Svago', 'Casa', 'Altro'];
let rules = [];
let currentSort = { field: 'data_valuta', order: 'desc' };
let charts = { pie: null, bar: null, line: null };
let selectedYear = '';

// Google Drive state
let tokenClient = null;
let accessToken = null;
let driveFileId = null;
let isSyncing = false;

// ============================================
// INDEXEDDB (fallback locale)
// ============================================
const DB_NAME = 'BankAnalyzerDB';
const DB_VERSION = 1;
let db = null;

async function initDB() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        request.onerror = () => reject(request.error);
        request.onsuccess = () => { db = request.result; resolve(db); };
        request.onupgradeneeded = (e) => {
            const database = e.target.result;
            if (!database.objectStoreNames.contains('transactions')) {
                database.createObjectStore('transactions', { keyPath: 'id', autoIncrement: true });
            }
            if (!database.objectStoreNames.contains('rules')) {
                database.createObjectStore('rules', { keyPath: 'id', autoIncrement: true });
            }
        };
    });
}

async function saveToLocalDB(storeName, data) {
    return new Promise((resolve, reject) => {
        const tx = db.transaction(storeName, 'readwrite');
        const store = tx.objectStore(storeName);
        store.clear();
        data.forEach((item, i) => store.put({ ...item, id: i }));
        tx.oncomplete = () => resolve();
        tx.onerror = () => reject(tx.error);
    });
}

async function loadFromLocalDB(storeName) {
    return new Promise((resolve, reject) => {
        const tx = db.transaction(storeName, 'readonly');
        const store = tx.objectStore(storeName);
        const request = store.getAll();
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
    });
}

// ============================================
// GOOGLE DRIVE API
// ============================================
function initGoogleAPI() {
    if (!GOOGLE_CLIENT_ID) {
        document.getElementById('setupInfo').style.display = 'block';
        document.getElementById('gdriveBtn').style.display = 'none';
        document.getElementById('gdriveStatus').style.display = 'none';
        return;
    }
    
    // Inizializza il token client
    tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: GOOGLE_CLIENT_ID,
        scope: SCOPES,
        callback: handleTokenResponse
    });
    
    // Controlla se c'√® un token salvato
    const savedToken = localStorage.getItem('gdrive_token');
    if (savedToken) {
        accessToken = savedToken;
        validateAndLoadFromDrive();
    }
}

function handleTokenResponse(response) {
    if (response.error) {
        console.error('Token error:', response);
        showToast('Errore autenticazione Google', 'error');
        return;
    }
    
    accessToken = response.access_token;
    localStorage.setItem('gdrive_token', accessToken);
    updateGDriveUI(true);
    loadFromGoogleDrive();
}

function handleGoogleAuth() {
    if (accessToken) {
        // Disconnetti
        google.accounts.oauth2.revoke(accessToken, () => {
            accessToken = null;
            driveFileId = null;
            localStorage.removeItem('gdrive_token');
            localStorage.removeItem('gdrive_file_id');
            updateGDriveUI(false);
            showToast('Disconnesso da Google Drive');
        });
    } else {
        // Connetti
        tokenClient.requestAccessToken({ prompt: 'consent' });
    }
}

async function validateAndLoadFromDrive() {
    try {
        // Verifica se il token √® ancora valido
        const response = await fetch('https://www.googleapis.com/oauth2/v1/tokeninfo?access_token=' + accessToken);
        if (!response.ok) {
            throw new Error('Token non valido');
        }
        updateGDriveUI(true);
        await loadFromGoogleDrive();
    } catch (e) {
        // Token scaduto o non valido
        accessToken = null;
        localStorage.removeItem('gdrive_token');
        updateGDriveUI(false);
    }
}

function updateGDriveUI(connected, syncing = false) {
    const status = document.getElementById('gdriveStatus');
    const statusText = document.getElementById('gdriveStatusText');
    const btn = document.getElementById('gdriveBtn');
    const btnText = document.getElementById('gdriveBtnText');
    
    if (connected) {
        status.classList.add('connected');
        btn.classList.add('connected');
        btnText.textContent = 'Disconnetti';
        
        if (syncing) {
            statusText.innerHTML = '<span class="sync-icon">üîÑ</span> Sincronizzazione...';
        } else {
            statusText.textContent = 'Drive: connesso';
        }
    } else {
        status.classList.remove('connected');
        btn.classList.remove('connected');
        statusText.textContent = 'Drive: non connesso';
        btnText.textContent = 'Connetti Drive';
    }
}

async function findDriveFile() {
    // Cerca il file esistente
    const savedFileId = localStorage.getItem('gdrive_file_id');
    if (savedFileId) {
        try {
            const response = await fetch(`https://www.googleapis.com/drive/v3/files/${savedFileId}`, {
                headers: { 'Authorization': 'Bearer ' + accessToken }
            });
            if (response.ok) {
                driveFileId = savedFileId;
                return driveFileId;
            }
        } catch (e) {}
    }
    
    // Cerca per nome
    const query = encodeURIComponent(`name='${DRIVE_FILE_NAME}' and trashed=false`);
    const response = await fetch(`https://www.googleapis.com/drive/v3/files?q=${query}`, {
        headers: { 'Authorization': 'Bearer ' + accessToken }
    });
    
    if (response.ok) {
        const data = await response.json();
        if (data.files && data.files.length > 0) {
            driveFileId = data.files[0].id;
            localStorage.setItem('gdrive_file_id', driveFileId);
            return driveFileId;
        }
    }
    return null;
}

async function loadFromGoogleDrive() {
    if (!accessToken) return false;
    
    updateGDriveUI(true, true);
    
    try {
        const fileId = await findDriveFile();
        
        if (!fileId) {
            updateGDriveUI(true, false);
            showToast('Nessun file trovato su Drive, verr√† creato al primo salvataggio');
            return false;
        }
        
        const response = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, {
            headers: { 'Authorization': 'Bearer ' + accessToken }
        });
        
        if (!response.ok) throw new Error('Errore download file');
        
        const data = await response.json();
        
        // Carica i dati
        transactions = (data.transactions || []).map(t => ({
            ...t,
            data_valuta: t.data_valuta ? new Date(t.data_valuta) : null,
            data_contabile: t.data_contabile ? new Date(t.data_contabile) : null
        }));
        rules = data.rules || [];
        categories = data.categories || categories;
        
        // Salva anche in locale come cache
        await saveToLocalDB('transactions', transactions);
        await saveToLocalDB('rules', rules);
        
        updateGDriveUI(true, false);
        showToast(`Caricati ${transactions.length} movimenti da Google Drive`);
        return true;
        
    } catch (e) {
        console.error('Errore caricamento da Drive:', e);
        updateGDriveUI(true, false);
        showToast('Errore caricamento da Drive, uso dati locali', 'error');
        return false;
    }
}

async function saveToGoogleDrive() {
    if (!accessToken) return false;
    
    updateGDriveUI(true, true);
    
    const backup = {
        transactions,
        rules,
        categories,
        lastModified: new Date().toISOString()
    };
    
    try {
        if (!driveFileId) {
            // Crea nuovo file
            const metadata = {
                name: DRIVE_FILE_NAME,
                mimeType: 'application/json'
            };
            
            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
            form.append('file', new Blob([JSON.stringify(backup)], { type: 'application/json' }));
            
            const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + accessToken },
                body: form
            });
            
            if (!response.ok) throw new Error('Errore creazione file');
            
            const data = await response.json();
            driveFileId = data.id;
            localStorage.setItem('gdrive_file_id', driveFileId);
            
        } else {
            // Aggiorna file esistente
            const response = await fetch(`https://www.googleapis.com/upload/drive/v3/files/${driveFileId}?uploadType=media`, {
                method: 'PATCH',
                headers: {
                    'Authorization': 'Bearer ' + accessToken,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(backup)
            });
            
            if (!response.ok) throw new Error('Errore aggiornamento file');
        }
        
        updateGDriveUI(true, false);
        return true;
        
    } catch (e) {
        console.error('Errore salvataggio su Drive:', e);
        updateGDriveUI(true, false);
        showToast('Errore salvataggio su Drive', 'error');
        return false;
    }
}

// ============================================
// SAVE DATA (locale + cloud)
// ============================================
async function saveTransactions() {
    await saveToLocalDB('transactions', transactions);
    if (accessToken) {
        await saveToGoogleDrive();
    }
}

async function saveRules() {
    await saveToLocalDB('rules', rules);
    if (accessToken) {
        await saveToGoogleDrive();
    }
}

// ============================================
// PARSING XLSX
// ============================================
function parseDate(val) {
    if (!val) return null;
    if (val instanceof Date) return val;
    if (typeof val === 'number') {
        const date = new Date((val - 25569) * 86400 * 1000);
        return isNaN(date) ? null : date;
    }
    const str = String(val).trim();
    if (str.toLowerCase() === 'non contabilizzato') return null;
    const parts = str.split('/');
    if (parts.length === 3) {
        const d = parseInt(parts[0], 10), m = parseInt(parts[1], 10) - 1, y = parseInt(parts[2], 10);
        const date = new Date(y, m, d);
        return isNaN(date) ? null : date;
    }
    return null;
}

function parseAmount(val) {
    if (typeof val === 'number') return val;
    if (!val) return NaN;
    const str = String(val).replace(/[‚Ç¨\s]/g, '').replace(',', '.');
    return parseFloat(str);
}

function getMonthFromDate(date) {
    if (!date) return null;
    return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
}

function parseXLSX(data) {
    const workbook = XLSX.read(data, { type: 'array' });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });
    
    let headerRowIndex = 7;
    const headerRow = rows[headerRowIndex];
    if (!headerRow) { showToast('Formato file non valido', 'error'); return []; }
    
    const colMap = {};
    const colNames = ['Data contabile', 'Data valuta', 'Descrizione', 'Dettaglio', 'Importo'];
    headerRow.forEach((cell, i) => {
        const name = String(cell).trim();
        if (colNames.includes(name)) colMap[name] = i;
    });
    
    if (Object.keys(colMap).length < 5) {
        showToast('Colonne mancanti nel file', 'error');
        return [];
    }
    
    const result = [];
    for (let i = headerRowIndex + 1; i < rows.length; i++) {
        const row = rows[i];
        if (!row || row.length === 0) continue;
        
        const desc = String(row[colMap['Descrizione']] || '').trim();
        const importoRaw = row[colMap['Importo']];
        const importo = parseAmount(importoRaw);
        
        if (!desc || desc === 'Descrizione' || isNaN(importo)) continue;
        
        const dataValuta = parseDate(row[colMap['Data valuta']]);
        if (!dataValuta) continue;
        
        const dataContabile = parseDate(row[colMap['Data contabile']]);
        const dettaglio = String(row[colMap['Dettaglio']] || '').trim();
        const mese = getMonthFromDate(dataContabile) || getMonthFromDate(dataValuta);
        
        result.push({
            data_valuta: dataValuta,
            data_contabile: dataContabile,
            descrizione: desc,
            dettaglio: dettaglio,
            importo: importo,
            tipo: importo >= 0 ? 'entrata' : 'uscita',
            mese: mese,
            categoria: ''
        });
    }
    
    return result;
}

// ============================================
// MONTH MANAGEMENT
// ============================================
function getLoadedMonths() {
    const monthsMap = {};
    transactions.forEach(t => {
        if (t.mese) {
            if (!monthsMap[t.mese]) monthsMap[t.mese] = 0;
            monthsMap[t.mese]++;
        }
    });
    return monthsMap;
}

function getYearsFromData() {
    const years = new Set();
    transactions.forEach(t => {
        if (t.mese) years.add(t.mese.substring(0, 4));
    });
    return [...years].sort().reverse();
}

function renderLoadedMonths() {
    const container = document.getElementById('monthsTags');
    const monthsMap = getLoadedMonths();
    const months = Object.keys(monthsMap).sort().reverse();
    const filteredMonths = selectedYear ? months.filter(m => m.startsWith(selectedYear)) : months;
    
    if (filteredMonths.length === 0) {
        container.innerHTML = '<span class="no-data-msg">Nessun dato caricato' + 
            (selectedYear ? ` per l'anno ${selectedYear}` : '') + '. Importa un file XLSX per iniziare.</span>';
        return;
    }
    
    const monthNames = ['Gen', 'Feb', 'Mar', 'Apr', 'Mag', 'Giu', 'Lug', 'Ago', 'Set', 'Ott', 'Nov', 'Dic'];
    
    container.innerHTML = filteredMonths.map(m => {
        const [year, month] = m.split('-');
        const monthName = monthNames[parseInt(month, 10) - 1];
        const count = monthsMap[m];
        return `
            <span class="month-tag">
                ${monthName} ${year}
                <span class="count">${count}</span>
                <button class="delete" onclick="confirmDeleteMonth('${m}')" title="Elimina questo mese">√ó</button>
            </span>
        `;
    }).join('');
}

function confirmDeleteMonth(month) {
    const [year, m] = month.split('-');
    const monthNames = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno', 
                        'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
    const monthName = monthNames[parseInt(m, 10) - 1];
    const count = transactions.filter(t => t.mese === month).length;
    
    document.getElementById('confirmMessage').innerHTML = 
        `Vuoi eliminare <strong>${monthName} ${year}</strong>?<br><small>(${count} transazioni)</small>`;
    document.getElementById('confirmBtn').onclick = () => deleteMonth(month);
    openModal('confirmModal');
}

async function deleteMonth(month) {
    transactions = transactions.filter(t => t.mese !== month);
    await saveTransactions();
    closeModal('confirmModal');
    updateYearSelector();
    updateMonthFilter();
    updateCategoryFilter();
    renderLoadedMonths();
    render();
    showToast('Mese eliminato');
}

function updateYearSelector() {
    const years = getYearsFromData();
    const select = document.getElementById('yearSelector');
    const current = select.value;
    select.innerHTML = '<option value="">Tutti gli anni</option>' + 
        years.map(y => `<option value="${y}">${y}</option>`).join('');
    if (years.includes(current)) {
        select.value = current;
    } else {
        select.value = '';
        selectedYear = '';
    }
}

// ============================================
// RULES
// ============================================
function applyRules(txList) {
    return txList.map(tx => {
        if (tx.categoria) return tx;
        const descLower = (tx.descrizione + ' ' + tx.dettaglio).toLowerCase();
        for (const rule of rules) {
            if (descLower.includes(rule.text.toLowerCase())) {
                return { ...tx, categoria: rule.category };
            }
        }
        return tx;
    });
}

function renderRules() {
    const container = document.getElementById('rulesList');
    container.innerHTML = rules.map((r, i) => `
        <div class="rule-item">
            <input type="text" value="${r.text}" onchange="updateRule(${i}, 'text', this.value)">
            <span>‚Üí</span>
            <input type="text" value="${r.category}" onchange="updateRule(${i}, 'category', this.value)">
            <button class="btn-danger" onclick="deleteRule(${i})">‚úï</button>
        </div>
    `).join('');
}

function addRule() {
    const text = document.getElementById('newRuleText').value.trim();
    const category = document.getElementById('newRuleCategory').value.trim();
    if (!text || !category) { showToast('Compila entrambi i campi', 'error'); return; }
    rules.push({ text, category });
    if (!categories.includes(category)) categories.push(category);
    document.getElementById('newRuleText').value = '';
    document.getElementById('newRuleCategory').value = '';
    saveRules();
    renderRules();
    updateCategoryFilter();
    showToast('Regola aggiunta');
}

function updateRule(index, field, value) {
    rules[index][field] = value;
    if (field === 'category' && !categories.includes(value)) categories.push(value);
    saveRules();
}

function deleteRule(index) {
    rules.splice(index, 1);
    saveRules();
    renderRules();
    showToast('Regola eliminata');
}

function applyRulesToAll() {
    transactions = applyRules(transactions.map(t => ({ ...t, categoria: '' })));
    saveTransactions();
    render();
    showToast('Regole applicate a tutte le transazioni');
    closeModal('rulesModal');
}

// ============================================
// FILTERS
// ============================================
function getFilters() {
    return {
        month: document.getElementById('filterMonth').value,
        type: document.getElementById('filterType').value,
        category: document.getElementById('filterCategory').value,
        search: document.getElementById('filterSearch').value.toLowerCase(),
        noCategory: document.getElementById('filterNoCategory').checked
    };
}

function saveFilters() {
    localStorage.setItem('bankFilters', JSON.stringify({ ...getFilters(), year: selectedYear }));
}

function loadFilters() {
    const saved = localStorage.getItem('bankFilters');
    if (saved) {
        const f = JSON.parse(saved);
        document.getElementById('filterMonth').value = f.month || '';
        document.getElementById('filterType').value = f.type || '';
        document.getElementById('filterCategory').value = f.category || '';
        document.getElementById('filterSearch').value = f.search || '';
        document.getElementById('filterNoCategory').checked = f.noCategory || false;
        if (f.year) {
            selectedYear = f.year;
            document.getElementById('yearSelector').value = f.year;
        }
    }
}

function filterTransactions() {
    const f = getFilters();
    return transactions.filter(t => {
        if (selectedYear && t.mese && !t.mese.startsWith(selectedYear)) return false;
        if (f.month && t.mese !== f.month) return false;
        if (f.type && t.tipo !== f.type) return false;
        if (f.category && t.categoria !== f.category) return false;
        if (f.noCategory && t.categoria) return false;
        if (f.search) {
            const searchStr = (t.descrizione + ' ' + t.dettaglio).toLowerCase();
            if (!searchStr.includes(f.search)) return false;
        }
        return true;
    });
}

function updateMonthFilter() {
    let months = [...new Set(transactions.map(t => t.mese).filter(Boolean))].sort().reverse();
    if (selectedYear) months = months.filter(m => m.startsWith(selectedYear));
    const select = document.getElementById('filterMonth');
    const current = select.value;
    select.innerHTML = '<option value="">Tutti</option>' + months.map(m => `<option value="${m}">${m}</option>`).join('');
    if (months.includes(current)) select.value = current;
}

function updateCategoryFilter() {
    const cats = [...new Set([...categories, ...transactions.map(t => t.categoria).filter(Boolean)])].sort();
    const select = document.getElementById('filterCategory');
    const current = select.value;
    select.innerHTML = '<option value="">Tutte</option>' + cats.map(c => `<option value="${c}">${c}</option>`).join('');
    if (cats.includes(current)) select.value = current;
}

// ============================================
// RENDERING
// ============================================
function formatDate(d) {
    if (!d) return 'Non contabilizzato';
    return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;
}

function formatAmount(a) {
    return a.toLocaleString('it-IT', { style: 'currency', currency: 'EUR' });
}

function render() {
    const filtered = filterTransactions();
    renderKPI(filtered);
    renderTable(filtered);
    renderCharts(filtered);
    renderStats(filtered);
}

function renderKPI(data) {
    const entrate = data.filter(t => t.tipo === 'entrata').reduce((s, t) => s + t.importo, 0);
    const uscite = data.filter(t => t.tipo === 'uscita').reduce((s, t) => s + Math.abs(t.importo), 0);
    const saldo = entrate - uscite;
    const numTx = data.length;
    const avgUscita = data.filter(t => t.tipo === 'uscita').length > 0 
        ? uscite / data.filter(t => t.tipo === 'uscita').length : 0;
    
    document.getElementById('kpiGrid').innerHTML = `
        <div class="kpi-card income"><div class="value">${formatAmount(entrate)}</div><div class="label">Entrate</div></div>
        <div class="kpi-card expense"><div class="value">${formatAmount(uscite)}</div><div class="label">Uscite</div></div>
        <div class="kpi-card balance"><div class="value">${formatAmount(saldo)}</div><div class="label">Saldo</div></div>
        <div class="kpi-card"><div class="value">${numTx}</div><div class="label">Transazioni</div></div>
        <div class="kpi-card expense"><div class="value">${formatAmount(avgUscita)}</div><div class="label">Media Uscita</div></div>
    `;
}

function renderTable(data) {
    const sorted = [...data].sort((a, b) => {
        let va = a[currentSort.field], vb = b[currentSort.field];
        if (currentSort.field === 'data_valuta' || currentSort.field === 'data_contabile') {
            va = va ? va.getTime() : 0;
            vb = vb ? vb.getTime() : 0;
        }
        if (va < vb) return currentSort.order === 'asc' ? -1 : 1;
        if (va > vb) return currentSort.order === 'asc' ? 1 : -1;
        return 0;
    });
    
    const tbody = document.getElementById('tableBody');
    const allCats = [...new Set([...categories, ...transactions.map(t => t.categoria).filter(Boolean)])].sort();
    
    if (sorted.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;padding:2rem;color:var(--gray-500);">
            <div>üì≠ Nessuna transazione</div>
            <small>Carica un file XLSX o modifica i filtri</small>
        </td></tr>`;
    } else {
        tbody.innerHTML = sorted.map((t) => {
            const origIndex = transactions.indexOf(t);
            const amountClass = t.importo >= 0 ? 'amount-positive' : 'amount-negative';
            const catOptions = allCats.map(c => `<option value="${c}" ${t.categoria === c ? 'selected' : ''}>${c}</option>`).join('');
            return `
                <tr class="clickable" onclick="showDetail(${origIndex})">
                    <td>${formatDate(t.data_valuta)}</td>
                    <td>${formatDate(t.data_contabile)}</td>
                    <td>${t.descrizione}</td>
                    <td>${t.dettaglio}</td>
                    <td onclick="event.stopPropagation()">
                        <select class="category-select" onchange="updateCategory(${origIndex}, this.value)">
                            <option value="">-- Nessuna --</option>${catOptions}
                        </select>
                    </td>
                    <td class="${amountClass}">${formatAmount(t.importo)}</td>
                    <td><span class="type-badge type-${t.tipo}">${t.tipo}</span></td>
                </tr>
            `;
        }).join('');
    }
    
    const totEntrate = data.filter(t => t.tipo === 'entrata').reduce((s, t) => s + t.importo, 0);
    const totUscite = data.filter(t => t.tipo === 'uscita').reduce((s, t) => s + Math.abs(t.importo), 0);
    document.getElementById('tableFooter').innerHTML = `
        <span>Totale: ${data.length} transazioni</span>
        <span>
            <span class="amount-positive">${formatAmount(totEntrate)}</span> | 
            <span class="amount-negative">-${formatAmount(totUscite)}</span> | 
            Saldo: ${formatAmount(totEntrate - totUscite)}
        </span>
    `;
    
    document.querySelectorAll('th[data-sort]').forEach(th => {
        th.classList.remove('sorted-asc', 'sorted-desc');
        if (th.dataset.sort === currentSort.field) {
            th.classList.add(currentSort.order === 'asc' ? 'sorted-asc' : 'sorted-desc');
        }
    });
}

function renderCharts(data) {
    Object.values(charts).forEach(c => c && c.destroy());
    
    const catData = {};
    data.filter(t => t.tipo === 'uscita').forEach(t => {
        const cat = t.categoria || 'Senza categoria';
        catData[cat] = (catData[cat] || 0) + Math.abs(t.importo);
    });
    const catLabels = Object.keys(catData);
    const catValues = Object.values(catData);
    const colors = ['#2563eb','#10b981','#f59e0b','#ef4444','#8b5cf6','#ec4899','#06b6d4','#84cc16','#f97316','#6366f1'];
    
    charts.pie = new Chart(document.getElementById('pieChart'), {
        type: 'doughnut',
        data: { labels: catLabels, datasets: [{ data: catValues, backgroundColor: colors }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
    });
    
    const topCats = catLabels.map((l, i) => ({ label: l, value: catValues[i] })).sort((a, b) => b.value - a.value).slice(0, 10);
    charts.bar = new Chart(document.getElementById('barChart'), {
        type: 'bar',
        data: {
            labels: topCats.map(c => c.label),
            datasets: [{ label: 'Spesa', data: topCats.map(c => c.value), backgroundColor: '#2563eb' }]
        },
        options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', plugins: { legend: { display: false } } }
    });
    
    const sorted = [...data].sort((a, b) => a.data_valuta - b.data_valuta);
    let cumulative = 0;
    const lineData = sorted.map(t => {
        cumulative += t.importo;
        return { x: formatDate(t.data_valuta), y: cumulative };
    });
    
    charts.line = new Chart(document.getElementById('lineChart'), {
        type: 'line',
        data: {
            labels: lineData.map(d => d.x),
            datasets: [{
                label: 'Saldo Cumulativo',
                data: lineData.map(d => d.y),
                borderColor: '#2563eb',
                backgroundColor: 'rgba(37,99,235,0.1)',
                fill: true,
                tension: 0.3
            }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
    });
}

function renderStats(data) {
    const topSpese = data.filter(t => t.tipo === 'uscita').sort((a, b) => a.importo - b.importo).slice(0, 10);
    const descCount = {};
    data.forEach(t => { descCount[t.descrizione] = (descCount[t.descrizione] || 0) + 1; });
    const topDesc = Object.entries(descCount).sort((a, b) => b[1] - a[1]).slice(0, 10);
    const catTotals = {};
    const totalUscite = data.filter(t => t.tipo === 'uscita').reduce((s, t) => s + Math.abs(t.importo), 0);
    data.filter(t => t.tipo === 'uscita').forEach(t => {
        const cat = t.categoria || 'Senza categoria';
        catTotals[cat] = (catTotals[cat] || 0) + Math.abs(t.importo);
    });
    
    document.getElementById('topLists').innerHTML = `
        <div class="top-list">
            <h3>üîù Top 10 Spese</h3>
            ${topSpese.length ? topSpese.map(t => `<div class="top-item"><span class="name">${t.descrizione}</span><span class="value amount-negative">${formatAmount(t.importo)}</span></div>`).join('') : '<p style="color:var(--gray-500)">Nessuna spesa</p>'}
        </div>
        <div class="top-list">
            <h3>üìä Descrizioni pi√π Frequenti</h3>
            ${topDesc.length ? topDesc.map(([d, c]) => `<div class="top-item"><span class="name">${d}</span><span class="value">${c}x</span></div>`).join('') : '<p style="color:var(--gray-500)">Nessun dato</p>'}
        </div>
        <div class="top-list">
            <h3>üìÅ Spese per Categoria</h3>
            ${Object.keys(catTotals).length ? Object.entries(catTotals).sort((a,b) => b[1] - a[1]).map(([cat, tot]) => {
                const perc = totalUscite > 0 ? ((tot / totalUscite) * 100).toFixed(1) : 0;
                return `<div class="top-item"><span class="name">${cat}</span><span class="value">${formatAmount(tot)} (${perc}%)</span></div>`;
            }).join('') : '<p style="color:var(--gray-500)">Nessuna spesa categorizzata</p>'}
        </div>
    `;
}

// ============================================
// INTERACTIONS
// ============================================
function updateCategory(index, value) {
    transactions[index].categoria = value;
    if (value && !categories.includes(value)) categories.push(value);
    saveTransactions();
    updateCategoryFilter();
    render();
}

function showDetail(index) {
    const t = transactions[index];
    document.getElementById('detailBody').innerHTML = `
        <div class="detail-row"><span class="detail-label">Data Valuta</span><span class="detail-value">${formatDate(t.data_valuta)}</span></div>
        <div class="detail-row"><span class="detail-label">Data Contabile</span><span class="detail-value">${formatDate(t.data_contabile)}</span></div>
        <div class="detail-row"><span class="detail-label">Descrizione</span><span class="detail-value">${t.descrizione}</span></div>
        <div class="detail-row"><span class="detail-label">Dettaglio</span><span class="detail-value">${t.dettaglio || '-'}</span></div>
        <div class="detail-row"><span class="detail-label">Importo</span><span class="detail-value ${t.importo >= 0 ? 'amount-positive' : 'amount-negative'}">${formatAmount(t.importo)}</span></div>
        <div class="detail-row"><span class="detail-label">Tipo</span><span class="detail-value"><span class="type-badge type-${t.tipo}">${t.tipo}</span></span></div>
        <div class="detail-row"><span class="detail-label">Categoria</span><span class="detail-value">${t.categoria || 'Nessuna'}</span></div>
        <div class="detail-row"><span class="detail-label">Mese</span><span class="detail-value">${t.mese}</span></div>
    `;
    openModal('detailModal');
}

function openModal(id) { document.getElementById(id).classList.add('active'); }
function closeModal(id) { document.getElementById(id).classList.remove('active'); }
function openRulesModal() { renderRules(); openModal('rulesModal'); }

function showToast(msg, type = 'success') {
    const toast = document.getElementById('toast');
    toast.textContent = msg;
    toast.className = 'toast ' + type + ' show';
    setTimeout(() => toast.classList.remove('show'), 3000);
}

// ============================================
// BACKUP
// ============================================
function exportBackup() {
    const backup = { transactions, rules, categories, exportDate: new Date().toISOString() };
    const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `backup_movimenti_${new Date().toISOString().slice(0,10)}.json`;
    a.click();
    showToast('Backup esportato');
}

async function importBackup(file) {
    try {
        const text = await file.text();
        const backup = JSON.parse(text);
        transactions = backup.transactions.map(t => ({
            ...t,
            data_valuta: t.data_valuta ? new Date(t.data_valuta) : null,
            data_contabile: t.data_contabile ? new Date(t.data_contabile) : null
        }));
        rules = backup.rules || [];
        categories = backup.categories || categories;
        await saveTransactions();
        await saveRules();
        updateYearSelector();
        updateMonthFilter();
        updateCategoryFilter();
        renderLoadedMonths();
        render();
        showToast('Backup importato: ' + transactions.length + ' transazioni');
    } catch (e) {
        showToast('Errore importazione: ' + e.message, 'error');
    }
}

// ============================================
// EVENT LISTENERS
// ============================================
document.getElementById('fileInput').addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    try {
        const buffer = await file.arrayBuffer();
        const parsed = parseXLSX(new Uint8Array(buffer));
        if (parsed.length === 0) return;
        
        const withRules = applyRules(parsed);
        const newMonths = [...new Set(withRules.map(t => t.mese).filter(Boolean))];
        transactions = transactions.filter(t => !newMonths.includes(t.mese));
        transactions = [...transactions, ...withRules];
        
        await saveTransactions();
        updateYearSelector();
        updateMonthFilter();
        updateCategoryFilter();
        renderLoadedMonths();
        render();
        showToast(`Importate ${parsed.length} transazioni per: ${newMonths.join(', ')}`);
    } catch (err) {
        showToast('Errore lettura file: ' + err.message, 'error');
    }
    e.target.value = '';
});

document.getElementById('backupInput').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) importBackup(file);
    e.target.value = '';
});

document.getElementById('yearSelector').addEventListener('change', (e) => {
    selectedYear = e.target.value;
    saveFilters();
    updateMonthFilter();
    renderLoadedMonths();
    render();
});

['filterMonth', 'filterType', 'filterCategory', 'filterSearch', 'filterNoCategory'].forEach(id => {
    document.getElementById(id).addEventListener('change', () => { saveFilters(); render(); });
    if (id === 'filterSearch') {
        document.getElementById(id).addEventListener('input', () => { saveFilters(); render(); });
    }
});

document.querySelectorAll('th[data-sort]').forEach(th => {
    th.addEventListener('click', () => {
        const field = th.dataset.sort;
        if (currentSort.field === field) {
            currentSort.order = currentSort.order === 'asc' ? 'desc' : 'asc';
        } else {
            currentSort.field = field;
            currentSort.order = 'desc';
        }
        render();
    });
});

document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
    });
});

document.querySelectorAll('.modal-overlay').forEach(overlay => {
    overlay.addEventListener('click', (e) => {
        if (e.target === overlay) overlay.classList.remove('active');
    });
});

// ============================================
// INIT
// ============================================
async function init() {
    try {
        await initDB();
        
        // Carica dati locali come fallback
        transactions = (await loadFromLocalDB('transactions')).map(t => ({
            ...t,
            data_valuta: t.data_valuta ? new Date(t.data_valuta) : null,
            data_contabile: t.data_contabile ? new Date(t.data_contabile) : null
        }));
        rules = await loadFromLocalDB('rules');
        
        loadFilters();
        updateYearSelector();
        updateMonthFilter();
        updateCategoryFilter();
        renderLoadedMonths();
        render();
        
        // Inizializza Google API dopo il caricamento
        if (typeof google !== 'undefined' && google.accounts) {
            initGoogleAPI();
        } else {
            window.addEventListener('load', () => {
                setTimeout(initGoogleAPI, 500);
            });
        }
        
    } catch (e) {
        console.error('Init error:', e);
        showToast('Errore inizializzazione: ' + e.message, 'error');
    }
}

init();
</script>
</body>
</html>
